<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>サービスについてのアンケート</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Yu Gothic', 'Noto Sans JP', sans-serif;
      background-color: #f8f9fa;
    }
    .header-bg {
      background-color: #007bff;
      color: white;
    }
    .form-card {
      background: white;
      padding: 2rem;
      border-radius: 15px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      max-width: 600px;
      margin: auto;
    }
    .text-error { color: #dc3545; font-size: 0.875em; }
    .text-unanswered { color: #dc3545; font-weight: bold; margin-left: 0.5rem; }
  </style>
</head>
<body>
  <header class="header-bg py-3 sticky-top text-center">
    <h4 class="mb-0">✨ サービスアンケート</h4>
  </header>

  <main class="container py-5">
    <div class="form-card">
      <form id="surveyForm" onsubmit="return validateAndSubmit(event);">
        <!-- Q1 -->
        <div class="mb-4">
          <label for="q1_visit_date" class="form-label fw-bold">
            Q1. ご来店日 <span class="text-error">*必須</span><span id="q1_unanswered" class="text-unanswered d-none">未回答</span>
          </label>
          <input type="date" class="form-control" id="q1_visit_date">
          <div id="q1_error" class="text-error mt-1 d-none">ご来店日を選択してください。</div>
        </div>

        <!-- Q2 -->
        <div class="mb-4">
          <label class="form-label fw-bold">
            Q2. ご年齢 <span class="text-error">*必須</span><span id="q2_unanswered" class="text-unanswered d-none">未回答</span>
          </label>
          <div>
            <label><input type="radio" name="q2_age" value="10代">10代</label>
            <label><input type="radio" name="q2_age" value="20代">20代</label>
            <label><input type="radio" name="q2_age" value="30代">30代</label>
            <label><input type="radio" name="q2_age" value="40代">40代</label>
            <label><input type="radio" name="q2_age" value="50代">50代</label>
          </div>
          <div id="q2_error" class="text-error mt-1 d-none">ご年齢を選択してください。</div>
        </div>

        <!-- Q3 -->
        <div class="mb-4">
          <label class="form-label fw-bold">
            Q3. サービスを知ったきっかけ（複数可）<span class="text-error">*必須</span><span id="q3_unanswered" class="text-unanswered d-none">未回答</span>
          </label>
          <div>
            <label><input type="checkbox" name="q3_source" value="家族・友人">家族・友人</label>
            <label><input type="checkbox" name="q3_source" value="TVCM">TVCM</label>
            <label><input type="checkbox" name="q3_source" value="SNS">SNS</label>
            <label><input type="checkbox" name="q3_source" value="街頭広告">街頭広告</label>
            <label><input type="checkbox" name="q3_source" value="その他">その他</label>
          </div>
          <div id="q3_error" class="text-error mt-1 d-none">きっかけを一つ以上選択してください。</div>
        </div>

        <!-- Q4 -->
        <div class="mb-4">
          <label class="form-label fw-bold">
            Q4. サービス満足度（1～5）<span class="text-error">*必須</span><span id="q4_unanswered" class="text-unanswered d-none">未回答</span>
          </label>
          <div>
            <label><input type="radio" name="q4_satisfaction" value="1">1😢</label>
            <label><input type="radio" name="q4_satisfaction" value="2">2😅</label>
            <label><input type="radio" name="q4_satisfaction" value="3">3😐</label>
            <label><input type="radio" name="q4_satisfaction" value="4">4😀</label>
            <label><input type="radio" name="q4_satisfaction" value="5">5😆</label>
          </div>
          <div id="q4_error" class="text-error mt-1 d-none">満足度を選択してください。</div>
        </div>

        <!-- Q5 -->
        <div class="mb-4">
          <label for="q5_comment" class="form-label fw-bold">Q5. ご意見・ご要望（任意）</label>
          <textarea id="q5_comment" class="form-control"></textarea>
        </div>

        <div class="d-flex justify-content-between mt-4">
          <button type="button" class="btn btn-outline-secondary" onclick="showBackConfirm()">戻る</button>
          <button type="submit" class="btn btn-primary">回答</button>
        </div>
      </form>
    </div>
  </main>

  <!-- 完了モーダル -->
  <div class="modal fade" id="completionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-success text-white"><h5>完了</h5></div>
        <div class="modal-body text-center py-5">
          <p class="h4 mb-4">ご回答ありがとうございました！</p>
          <p>"終了"ボタンでブラウザを閉じてください。</p>
          <button type="button" class="btn btn-primary" onclick="closeBrowser()">終了</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 戻る確認モーダル -->
  <div class="modal fade" id="backModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h5>確認</h5></div>
        <div class="modal-body text-center"><p>回答内容が無効になります。よろしいですか？</p></div>
        <div class="modal-footer justify-content-around">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">いいえ</button>
          <button type="button" class="btn btn-danger" onclick="closeBrowser()">はい</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzbLbqwIO3JP4tYnYeZP48vLa806b9PQLcV0zofeg-bXAt9klVvGjsl5n-bPaPegqid/exec";
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code") || location.search.replace("?", "");

    // ▼ 起動時チェック：すでに「済」なら強制終了
    window.onload = async function() {
      if (!code) return;
      const res = await fetch(SCRIPT_URL + "?check=" + code);
      const text = await res.text();
      if (text === "済") {
        alert("既にアンケート回答済みの為、終了いたします。");
        closeBrowser();
      }
    };

    // ▼ 戻る確認モーダル
    function showBackConfirm() {
      new bootstrap.Modal(document.getElementById('backModal')).show();
    }

    // ▼ 未回答検出・送信処理
    async function validateAndSubmit(e) {
      e.preventDefault();
      const form = document.getElementById("surveyForm");
      let hasError = false;
      document.querySelectorAll(".text-error, .text-unanswered").forEach(el => el.classList.add("d-none"));
      let firstError = null;

      const required = [
        { id: "q1", check: () => !document.getElementById("q1_visit_date").value },
        { id: "q2", check: () => !form.querySelector('input[name="q2_age"]:checked') },
        { id: "q3", check: () => !form.querySelector('input[name="q3_source"]:checked') },
        { id: "q4", check: () => !form.querySelector('input[name="q4_satisfaction"]:checked') },
      ];
      for (const q of required) {
        if (q.check()) {
          document.getElementById(q.id + "_error").classList.remove("d-none");
          document.getElementById(q.id + "_unanswered").classList.remove("d-none");
          if (!firstError) firstError = document.getElementById(q.id + "_error");
          hasError = true;
        }
      }
      if (hasError) {
        firstError.scrollIntoView({ behavior: "smooth", block: "center" });
        return false;
      }

      // データ送信
      const data = {
        type: "answer",
        code: code,
        q1_visit_date: document.getElementById("q1_visit_date").value,
        q2_age: form.querySelector('input[name="q2_age"]:checked').value,
        q3_source: Array.from(form.querySelectorAll('input[name="q3_source"]:checked')).map(el => el.value),
        q4_satisfaction: form.querySelector('input[name="q4_satisfaction"]:checked').value,
        q5_comment: document.getElementById("q5_comment").value
      };

      await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(data) });

      new bootstrap.Modal(document.getElementById("completionModal")).show();
    }

    // ▼ ブラウザ閉鎖処理
    function closeBrowser() {
      window.open('', '_self').close();
    }
  </script>
</body>
</html>

