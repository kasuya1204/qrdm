<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>サービスについてのアンケート</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<style>
body {
  font-family: 'Yu Gothic', 'YuGothic', 'Noto Sans JP', sans-serif;
  color: #333;
  background-color: #f8f9fa;
}
.header-bg { background-color: #007bff; color: white; }
.container-hero { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 5rem 1rem; /* スマホ用に左右padding調整 */ }
.form-card {
  background-color: white; padding: 2rem; border-radius: 15px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); max-width: 600px; width: 100%;
}
.btn-pill { border-radius: 50rem; padding-left: 1.5rem; padding-right: 1.5rem; }
.text-error { color: #dc3545; font-size: 0.875em; }

/* --- バリデーションエラー用スタイル --- */
.form-control.is-invalid { /* input要素のエラー枠線 */
   border-color: #dc3545;
}
.form-control.is-invalid:focus {
  box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
}

/* 「未回答」メッセージ用のスタイル */
.validation-message {
    font-size: 0.9em;
    font-weight: bold;
}

</style>
</head>
<body>

<header class="header-bg py-3 sticky-top text-center">
  <div class="h4 mb-0">✨ サービスアンケート</div>
</header>

<main class="container-hero">
  <div class="form-card">
    <h2 class="text-center mb-4" style="color:#007bff;">サービスについてのアンケート</h2>
    <form id="surveyForm" onsubmit="return submitSurvey(event)" novalidate>
      
      <!-- Q1 -->
      <div class="mb-4">
        <div class="d-flex align-items-center">
          <label for="q1_visit_date" class="form-label fw-bold mb-0">Q1. ご来店日はいつですか <span class="text-error">*必須</span></label>
          <span class="text-danger ms-2 d-none validation-message" id="q1_error">未回答</span>
        </div>
        <input type="date" class="form-control mt-1" id="q1_visit_date">
      </div>

      <!-- Q2 -->
      <div class="mb-4">
        <div class="d-flex align-items-center">
          <label class="form-label fw-bold mb-0" id="q2_label">Q2. ご年齢 <span class="text-error">*必須</span></label>
          <span class="text-danger ms-2 d-none validation-message" id="q2_error">未回答</span>
        </div>
        <div class="d-flex flex-wrap mt-1">
          <div class="form-check me-3"><input class="form-check-input" type="radio" name="q2_age" value="10代"><label class="form-check-label">10代</label></div>
          <div class="form-check me-3"><input class="form-check-input" type="radio" name="q2_age" value="20代"><label class="form-check-label">20代</label></div>
          <div class="form-check me-3"><input class="form-check-input" type="radio" name="q2_age" value="30代"><label class="form-check-label">30代</label></div>
          <div class="form-check me-3"><input class="form-check-input" type="radio" name="q2_age" value="40代"><label class="form-check-label">40代</label></div>
          <div class="form-check"><input class="form-check-input" type="radio" name="q2_age" value="50代"><label class="form-check-label">50代</label></div>
        </div>
      </div>

      <!-- Q3 -->
      <div class="mb-4">
        <div class="d-flex align-items-center">
           <label class="form-label fw-bold mb-0" id="q3_label">Q3. サービスを知ったきっかけ（複数回答可） <span class="text-error">*必須</span></label>
           <span class="text-danger ms-2 d-none validation-message" id="q3_error">未回答</span>
        </div>
        <div class="d-flex flex-column mt-1">
          <label><input type="checkbox" name="q3_source" value="家族・友人"> 家族・友人</label>
          <label><input type="checkbox" name="q3_source" value="TVCM"> TVCM</label>
          <label><input type="checkbox" name="q3_source" value="SNS"> SNS</label>
          <label><input type="checkbox" name="q3_source" value="街頭広告"> 街頭広告</label>
          <label><input type="checkbox" name="q3_source" value="その他"> その他</label>
        </div>
      </div>

      <!-- Q4 -->
      <div class="mb-4">
        <div class="d-flex align-items-center">
          <label class="form-label fw-bold mb-0" id="q4_label">Q4. サービスの満足度（1～5） <span class="text-error">*必須</span></label>
          <span class="text-danger ms-2 d-none validation-message" id="q4_error">未回答</span>
        </div>
        <div class="d-flex justify-content-between flex-wrap mt-1"> <!-- スマホ用にwrap追加 -->
          <label class="m-1"><input type="radio" name="q4_satisfaction" value="1">1😢</label>
          <label class="m-1"><input type="radio" name="q4_satisfaction" value="2">2😅</label>
          <label class="m-1"><input type="radio" name="q4_satisfaction" value="3">3😐</label>
          <label class="m-1"><input type="radio" name="q4_satisfaction" value="4">4😀</label>
          <label class="m-1"><input type="radio" name="q4_satisfaction" value="5">5😆</label>
        </div>
      </div>

      <!-- Q5 -->
      <div class="mb-4">
        <label for="q5_comment" class="form-label fw-bold">Q5. ご意見・ご要望（任意）</label>
        <textarea class="form-control" id="q5_comment" rows="4"></textarea>
      </div>

      <div class="text-center">
        <button type="button" class="btn btn-outline-secondary btn-pill me-2" onclick="confirmExit()">戻る</button>
        <button type="submit" class="btn btn-primary btn-pill" id="submitButton">回答</button>
      </div>
    </form>
  </div>
</main>

<!-- 回答済みモーダル (既存) -->
<div class="modal fade" id="alreadyAnsweredModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark"><h5 class="modal-title">確認</h5></div>
      <div class="modal-body text-center py-5">
        <p class="h5 mb-4">既にアンケート回答済みの為、<br>終了いたします。</p>
        <button type="button" class="btn btn-primary btn-pill mt-3" onclick="closeBrowser()">終了</button>
      </div>
    </div>
  </div>
</div>

<!-- バリデーションエラーモーダル (既存) -->
<div class="modal fade" id="validationErrorModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white"><h5 class="modal-title">回答確認</h5></div>
      <div class="modal-body text-center py-4">
        <p class="h5 mb-3" id="validationErrorMessage">未回答必須項目があります。</p>
        <button type="button" class="btn btn-secondary btn-pill" data-bs-dismiss="modal">閉じる</button>
      </div>
    </div>
  </div>
</div>

<!-- 戻る確認モーダル (新規追加) -->
<div class="modal fade" id="confirmExitModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">確認</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center py-4">
        <p class="h5 mb-0">今までの回答が無効になりますが<br>宜しいですか？</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-secondary btn-pill" data-bs-dismiss="modal">キャンセル</button>
        <button type="button" class="btn btn-primary btn-pill" onclick="closeBrowser()">終了する</button>
      </div>
    </div>
  </div>
</div>


<!-- 回答完了モーダル (既存) -->
<div class="modal fade" id="completionModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white"><h5 class="modal-title">完了</h5></div>
      <div class="modal-body text-center py-5">
        <p class="h4 mb-4">ご回答ありがとうございました！</p>
        <p>"終了"ボタンでブラウザを終了してください。</p>
        <button type="button" class="btn btn-primary btn-pill mt-3" onclick="closeBrowser()">終了</button>
      </div>
    </div>
  </div>
</div>

<footer class="bg-dark text-white py-4 text-center mt-5">
  <small>© 2025 Service Survey</small>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// --- Google Apps Script URL をここに貼ってください ---
const GAS_URL = "https://script.google.com/macros/s/AKfycbzbLbqwIO3JP4tYnYeZP48vLa806b9PQLcV0zofeg-bXAt9klVvGjsl5n-bPaPegqid/exec";

// --- パラメータ取得（例：?12345） ---
const code = window.location.search.replace("?", "") || "00000";

// --- モーダルインスタンスの準備 ---
let validationErrorModal;
let confirmExitModal; // 戻る確認モーダル用
document.addEventListener('DOMContentLoaded', function () {
    if (document.getElementById('validationErrorModal')) {
        validationErrorModal = new bootstrap.Modal(document.getElementById('validationErrorModal'));
    }
    if (document.getElementById('confirmExitModal')) { // 追加
        confirmExitModal = new bootstrap.Modal(document.getElementById('confirmExitModal'));
    }
});


// --- アクセス記録 & 回答済みチェック ---
window.onload = async function() {
  let ip = "取得不可", lat = "", lon = "";
  try {
    const ipRes = await fetch("https://api.ipify.org?format=json");
    ip = (await ipRes.json()).ip;
  } catch(e){}
  
  // 位置情報を取得試行
  navigator.geolocation.getCurrentPosition(
    pos => checkStatusAndLog(ip, pos.coords.latitude, pos.coords.longitude),
    ()  => checkStatusAndLog(ip, lat, lon) // 位置情報が取れなくても実行
  );
};

// GASに状態確認とアクセスログ送信を依頼する
async function checkStatusAndLog(ip, lat, lon) {
  try {
    const response = await fetch(GAS_URL, {
      method: "POST",
      // タイムアウトを設ける（例：8秒）
      signal: AbortSignal.timeout(8000), 
      body: JSON.stringify({
        type: "access",
        code: code,
        ip: ip,
        lat: lat,
        lon: lon,
        device: navigator.userAgent
      })
    });
    
    const result = await response.json(); // {status: "answered"} または {status: "logged"}

    if (result.status === "answered") {
      // 回答済みの場合
      const modal = new bootstrap.Modal(document.getElementById('alreadyAnsweredModal'));
      modal.show();
    } 
    // "logged" の場合は、GAS側でログが記録され、アンケートに進む（何もしない）

  } catch (e) {
    // ネットワークエラーやタイムアウトの場合
    // 回答済みチェックができなかったが、アンケートは続行させる
    console.warn("Could not check status, proceeding anyway.", e);
  }
}


// --- 回答処理（バリデーション強化） ---
async function submitSurvey(event) {
  event.preventDefault();
  const form = event.target;
  let firstErrorElement = null;

  // バリデーションエラーメッセージをリセット
  form.q1_visit_date.classList.remove('is-invalid');
  document.getElementById('q1_error').classList.add('d-none');
  document.getElementById('q2_error').classList.add('d-none');
  document.getElementById('q3_error').classList.add('d-none');
  document.getElementById('q4_error').classList.add('d-none');

  // Q2, Q3, Q4 のラベル要素を取得 (スクロールターゲット用)
  const q2Label = document.getElementById('q2_label');
  const q3Label = document.getElementById('q3_label');
  const q4Label = document.getElementById('q4_label');


  // Q1. ご来店日
  if (!form.q1_visit_date.value) {
    form.q1_visit_date.classList.add('is-invalid'); // input枠線を赤くする
    document.getElementById('q1_error').classList.remove('d-none'); // 「未回答」表示
    if (!firstErrorElement) firstErrorElement = form.q1_visit_date;
  }

  // Q2. ご年齢
  if (!form.q2_age.value) {
    document.getElementById('q2_error').classList.remove('d-none'); // 「未回答」表示
    if (!firstErrorElement) firstErrorElement = q2Label; // スクロールターゲットはラベル
  }

  // Q3. きっかけ
  if (form.querySelectorAll('input[name="q3_source"]:checked').length === 0) {
    document.getElementById('q3_error').classList.remove('d-none'); // 「未回答」表示
    if (!firstErrorElement) firstErrorElement = q3Label;
  }

  // Q4. 満足度
  if (!form.q4_satisfaction.value) {
    document.getElementById('q4_error').classList.remove('d-none'); // 「未回答」表示
    if (!firstErrorElement) firstErrorElement = q4Label;
  }

  // エラーがある場合
  if (firstErrorElement) {
    // エラーモーダルを表示
    const errorMessage = document.getElementById('validationErrorMessage');
    errorMessage.textContent = '未回答必須項目があります。';
    if(validationErrorModal) validationErrorModal.show();
    
    // エラー箇所へスクロール
    firstErrorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
    return; // 送信処理を中断
  }
  
  // ローディング表示
  const submitButton = document.getElementById('submitButton');
  submitButton.disabled = true;
  submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 送信中...';


  // バリデーション通過後
  const data = {
    type: "answer",
    code: code,
    q1_visit_date: form.q1_visit_date.value,
    q2_age: form.q2_age.value,
    q3_source: Array.from(form.querySelectorAll('input[name="q3_source"]:checked')).map(e=>e.value),
    q4_satisfaction: form.q4_satisfaction.value,
    q5_comment: form.q5_comment.value
  };

  try {
    await fetch(GAS_URL, { 
        method: "POST", 
        body: JSON.stringify(data),
        signal: AbortSignal.timeout(10000) // 送信タイムアウト
    });

    const modal = new bootstrap.Modal(document.getElementById('completionModal'));
    modal.show();

  } catch (e) {
    // 送信失敗時
    console.error("Submit failed:", e);
    const errorMessage = document.getElementById('validationErrorMessage');
    errorMessage.textContent = '送信に失敗しました。ネットワーク接続を確認して再度お試しください。';
    if(validationErrorModal) validationErrorModal.show();
  } finally {
    // ボタンを元に戻す
    submitButton.disabled = false;
    submitButton.innerHTML = '回答';
  }
}

// --- 戻るボタン機能 ---
function confirmExit() {
  if (confirmExitModal) {
    confirmExitModal.show();
  }
}

// --- 終了処理 ---
function closeBrowser() {
  window.open('about:blank', '_self');
  window.close();
  setTimeout(() => {
    document.body.innerHTML = "<div style='text-align:center;padding-top:50px; font-family: sans-serif;'>ブラウザを終了してください。</div>";
  }, 500);
}
</script>

</body>
</html>